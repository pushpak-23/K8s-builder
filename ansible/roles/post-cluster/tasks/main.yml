---
# -------------------------
# 1. Verification
# -------------------------
- name: Wait for kubeconfig to exist
  wait_for:
    path: /etc/rancher/rke2/rke2.yaml
    timeout: 300

- name: Verify cluster is ready (nodes visible)
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl get nodes
  register: api_check
  retries: 30
  delay: 10
  until: api_check.rc == 0


- name: Wait for CoreDNS rollout (configured via bootstrap)
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl -n kube-system rollout status deployment rke2-coredns-rke2-coredns --timeout=180s
  register: coredns_rollout
  retries: 12
  delay: 15
  until: coredns_rollout.rc == 0

- name: Wait for Cilium rollout (configured via bootstrap)
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl -n kube-system rollout status daemonset cilium --timeout=300s
    kubectl -n kube-system rollout status deployment cilium-operator --timeout=180s
  register: cilium_rollout
  retries: 15
  delay: 20
  until: cilium_rollout.rc == 0


# -------------------------
# 3. CoreDNS Patch (RKE2-safe)
# -------------------------
- name: Patch CoreDNS via HelmChartConfig (extraCorefile)
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml

    cat <<EOF | kubectl apply -f -
    apiVersion: helm.cattle.io/v1
    kind: HelmChartConfig
    metadata:
      name: rke2-coredns
      namespace: kube-system
    spec:
      valuesContent: |-
        extraCorefile: |
          hosts {
              192.168.101.10 vip-internal-cloud vip.internal.cloud
              192.168.103.10 vip-public-cloud vip.public.cloud
              fallthrough
          }

          forward . 192.168.176.17
    EOF
  register: coredns_patch
  changed_when: "'created' in coredns_patch.stdout or 'configured' in coredns_patch.stdout"

- name: Restart CoreDNS to apply patched config
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl -n kube-system rollout restart deployment rke2-coredns-rke2-coredns
  register: coredns_restart
  retries: 5
  delay: 10
  until: coredns_restart.rc == 0
  changed_when: "'restarted' in coredns_restart.stdout"

# -------------------------
# 4. Hubble UI (Ingress)
# -------------------------

- name: Ensure Hubble UI service exists (ClusterIP)
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl -n kube-system get svc hubble-ui
  register: hubble_svc_check
  failed_when: hubble_svc_check.rc != 0

- name: Create Ingress for Hubble UI
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    cat <<EOF | kubectl apply -f -
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: hubble-ui
      namespace: kube-system
      annotations:
        kubernetes.io/ingress.class: nginx
        nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
        nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
        nginx.ingress.kubernetes.io/websocket-services: "hubble-ui"
    spec:
      rules:
      - host: hubble.k8s.local
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: hubble-ui
                port:
                  number: 80
    EOF
  register: hubble_ingress_create
  changed_when: "'created' in hubble_ingress_create.stdout or 'configured' in hubble_ingress_create.stdout"

- name: Restart csi-cinder-controllerplugin deployment
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl -n kube-system rollout restart deployment csi-cinder-controllerplugin
  register: csi_cinder_restart
  retries: 5
  delay: 10
  until: csi_cinder_restart.rc == 0
  changed_when: "'restarted' in csi_cinder_restart.stdout or 'successfully' in csi_cinder_restart.stdout"

# -------------------------
# 5. Storage (Cinder)
# -------------------------
# Ensure Cinder CSI is installed before this runs!
- name: Create default Cinder StorageClass
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    cat <<EOF | kubectl apply -f -
    apiVersion: storage.k8s.io/v1
    kind: StorageClass
    metadata:
      name: cinder-sc
      annotations:
        storageclass.kubernetes.io/is-default-class: "true"
    provisioner: cinder.csi.openstack.org
    parameters:
      type: {{ default_volume_type }}
      fsType: xfs
    volumeBindingMode: WaitForFirstConsumer
    reclaimPolicy: Delete
    allowVolumeExpansion: true
    EOF
  register: sc_create
  changed_when: "'created' in sc_create.stdout or 'configured' in sc_create.stdout"

- name: Fetch admin kubeconfig to control host
  fetch:
    src: /etc/rancher/rke2/rke2.yaml
    dest: "{{ playbook_dir }}/artifacts/kubeconfig.raw"
    flat: yes