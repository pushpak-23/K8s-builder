---
# -------------------------
# 1. Verification
# -------------------------

- name: Wait for kubeconfig to exist
  wait_for:
    path: /etc/rancher/rke2/rke2.yaml
    timeout: 300

- name: Verify cluster is ready (nodes visible)
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl get nodes
  register: api_check
  retries: 30
  delay: 10
  until: api_check.rc == 0


- name: Wait for CoreDNS rollout
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl -n kube-system rollout status deployment rke2-coredns-rke2-coredns --timeout=180s
  register: coredns_rollout
  retries: 12
  delay: 15
  until: coredns_rollout.rc == 0


- name: Wait for Cilium rollout
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl -n kube-system rollout status daemonset cilium --timeout=300s
    kubectl -n kube-system rollout status deployment cilium-operator --timeout=180s
  register: cilium_rollout
  retries: 15
  delay: 20
  until: cilium_rollout.rc == 0


# -------------------------
# 2. CoreDNS Patch (RKE2-safe)
# -------------------------

- name: Patch CoreDNS via HelmChartConfig
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml

    cat <<EOF | kubectl apply -f -
    apiVersion: helm.cattle.io/v1
    kind: HelmChartConfig
    metadata:
      name: rke2-coredns
      namespace: kube-system
    spec:
      valuesContent: |-
        extraCorefile: |
          hosts {
              192.168.101.10 vip-internal-cloud vip.internal.cloud
              192.168.103.10 vip-public-cloud vip.public.cloud
              fallthrough
          }

          forward . 192.168.176.17
    EOF
  register: coredns_patch
  changed_when: "'created' in coredns_patch.stdout or 'configured' in coredns_patch.stdout"


- name: Restart CoreDNS
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl -n kube-system rollout restart deployment rke2-coredns-rke2-coredns
  register: coredns_restart
  retries: 5
  delay: 10
  until: coredns_restart.rc == 0


- name: Restart csi-cinder-controllerplugin
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl -n kube-system rollout restart deployment csi-cinder-controllerplugin
  register: csi_cinder_restart
  retries: 5
  delay: 10
  until: csi_cinder_restart.rc == 0


# -------------------------
# 6. Storage (Cinder)
# -------------------------

- name: Create default Cinder StorageClass
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml

    cat <<EOF | kubectl apply -f -
    apiVersion: storage.k8s.io/v1
    kind: StorageClass
    metadata:
      name: cinder-sc
      annotations:
        storageclass.kubernetes.io/is-default-class: "true"
    provisioner: cinder.csi.openstack.org
    parameters:
      type: {{ default_volume_type }}
      fsType: xfs
    volumeBindingMode: WaitForFirstConsumer
    reclaimPolicy: Delete
    allowVolumeExpansion: true
    EOF
  register: sc_create
  changed_when: "'created' in sc_create.stdout or 'configured' in sc_create.stdout"


# -------------------------
# 7. Fetch kubeconfig
# -------------------------

- name: Fetch admin kubeconfig
  fetch:
    src: /etc/rancher/rke2/rke2.yaml
    dest: "{{ playbook_dir }}/artifacts/kubeconfig.raw"
    flat: yes
