- name: Stop RKE2 if running
  systemd:
    name: rke2-server
    state: stopped
  ignore_errors: true

- name: Remove old RKE2 data (force cert regeneration)
  file:
    path: /var/lib/rancher/rke2
    state: absent
  when: inventory_hostname == groups['masters'][0]

- name: Install RKE2 server
  shell: curl -sfL https://get.rke2.io | INSTALL_RKE2_VERSION={{ rke2_version }} sh -
  args:
    creates: /usr/local/bin/rke2

- name: Create RKE2 config directory
  file:
    path: /etc/rancher/rke2
    state: directory
    mode: '0755'

- name: Configure bootstrap master
  copy:
    dest: /etc/rancher/rke2/config.yaml
    mode: '0600'
    content: |
      token: {{ rke2_token }}
      cluster-init: true
      data-dir: {{ rke2_data_dir }}

      node-name: {{ inventory_hostname }}
      node-ip: {{ private_ip }}
      advertise-address: {{ private_ip }}

      {% set tls_sans = [
        private_ip,
        '127.0.0.1',
        'localhost',
        rke2_lb_host
      ] %}
      {% if cluster_fqdn is defined %}
      {% set _ = tls_sans.append(cluster_fqdn) %}
      {% endif %}

      tls-san:
      {% for san in tls_sans %}
        - {{ san }}
      {% endfor %}

      disable-cloud-controller: true
      cloud-provider-name: external

- name: Start RKE2 server
  systemd:
    name: rke2-server
    enabled: true
    state: started
